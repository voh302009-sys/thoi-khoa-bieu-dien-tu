<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Thời Khóa Biểu Điện Tử</title>

<style>
body { font-family: Arial; margin: 20px }
table { width:100%; border-collapse: collapse }
th,td { border:1px solid #ccc; padding:10px; text-align:center; vertical-align:top }
th { background:#f2f2f2 }

.subject { color:red; font-weight:bold }
.gv { color:blue; font-style:italic }
.warn { color:#b58900; font-size:13px; font-style:italic }
.conflict { background:#ffd6d6 }

.login,.form,.month { margin-bottom:15px }
button { padding:6px 12px; margin-top:5px }

@media print {
  .login,.form,.month,button { display:none }
}
</style>
</head>

<body>

<h1>Thời khóa biểu</h1>

<div class="login">
  <select id="role">
    <option value="student">Sinh viên</option>
    <option value="lecturer">Giảng viên</option>
  </select>
  <input id="password" type="password" placeholder="Mật khẩu">
  <button onclick="login()">Đăng nhập</button>
</div>

<div class="form" id="form" style="display:none">
  <input id="subject" placeholder="Tên môn"><br>
  <select id="type"><option>LT</option><option>TH</option></select>
  <input id="credits" type="number" placeholder="TC"><br>
  <input id="code" placeholder="Mã học phần"><br>
  <select id="day">
    <option>Thứ 2</option><option>Thứ 3</option><option>Thứ 4</option>
    <option>Thứ 5</option><option>Thứ 6</option><option>Thứ 7</option>
  </select>
  <select id="session"><option>Sáng</option><option>Chiều</option></select><br>
  <input id="time" placeholder="06:30-09:00"><br>
  <input id="room" placeholder="ADV, A.103"><br>
  <input id="lecturer" placeholder="Giảng viên"><br>
  <input id="start" type="date"> → <input id="end" type="date"><br>
  <button onclick="addClass()">Thêm</button>
</div>

<div class="month" style="display:none">
  <input type="month" id="month">
</div>

<table>
<thead>
<tr>
  <th>Phòng</th>
  <th>Thứ 2</th><th>Thứ 3</th><th>Thứ 4</th>
  <th>Thứ 5</th><th>Thứ 6</th><th>Thứ 7</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<script>
const passwords = { student:"sv123", lecturer:"gv123" }
let role = null
let filterMonth = null
let data = JSON.parse(localStorage.getItem("tkb") || "{}")

function login(){
  const r = document.getElementById("role").value
  const p = document.getElementById("password").value
  if(p !== passwords[r]) return alert("Sai mật khẩu")
  role = r
  document.querySelector(".login").style.display="none"
  document.querySelector(".month").style.display="block"
  if(r==="lecturer") document.getElementById("form").style.display="block"
  render()
}

function addClass(){
  const c = {
    subject:subject.value, type:type.value, credits:credits.value,
    code:code.value, day:day.value, session:session.value,
    time:time.value, room:room.value, lecturer:lecturer.value,
    start:start.value, end:end.value
  }
  if(!data[c.room]) data[c.room]={}
  if(!data[c.room][c.day]) data[c.room][c.day]=[]
  data[c.room][c.day].push(c)
  localStorage.setItem("tkb",JSON.stringify(data))
  render()
}

function overlap(a,b){
  const p=x=>x.split("-").map(t=>{
    let [h,m]=t.split(":"); return h*60+ +m
  })
  let [s1,e1]=p(a),[s2,e2]=p(b)
  return !(e1<=s2||e2<=s1)
}

function render(){
  const b=document.getElementById("body"); b.innerHTML=""
  Object.keys(data).sort().forEach(r=>{
    let show=false
    Object.values(data[r]).flat().forEach(c=>{
      if(!filterMonth) show=true
      else{
        let d=new Date(c.start)
        if(c.start.startsWith(filterMonth)) show=true
      }
    })
    if(!show) return
    let tr=`<tr><td><b>${r}</b></td>`
    ;["Thứ 2","Thứ 3","Thứ 4","Thứ 5","Thứ 6","Thứ 7"].forEach(d=>{
      let cell=""
      if(data[r][d]){
        data[r][d].forEach((c,i)=>{
          let conflict=false
          Object.keys(data).forEach(rr=>{
            data[rr][d]?.forEach(o=>{
              if(o!==c && o.session===c.session && overlap(o.time,c.time))
                conflict=true
            })
          })
          cell+=`
          <div class="${conflict?'conflict':''}">
            <div class="subject">${c.subject} (${c.type}) - ${c.credits} TC</div>
            ${c.session} ${c.time}<br>${c.room}<br>
            <span class="gv">GV: ${c.lecturer}</span>
            ${role==="lecturer"?`<br><button onclick="del('${r}','${d}',${i})">Xóa</button>`:""}
          </div>`
        })
      }
      tr+=`<td>${cell}</td>`
    })
    b.innerHTML+=tr+"</tr>"
  })
}

function del(r,d,i){
  if(!confirm("Xóa?")) return
  data[r][d].splice(i,1)
  localStorage.setItem("tkb",JSON.stringify(data))
  render()
}

document.getElementById("month").onchange=e=>{
  filterMonth=e.target.value
  render()
}
</script>
</body>
</html>
